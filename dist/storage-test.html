<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Firebase Storage Sanity Test (Resumable)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { background:#0a0a0a; color:#fff; font-family:system-ui,Segoe UI,Roboto,Arial; padding:24px; }
    .card { border:1px solid rgba(255,255,255,.12); border-radius:12px; padding:16px; max-width:880px; }
    button { padding:10px 14px; border-radius:10px; border:none; font-weight:700; cursor:pointer; }
    .ok { background:#1a73e8; color:white; }
    pre { background:#111; border:1px solid rgba(255,255,255,.08); border-radius:10px; padding:12px; white-space:pre-wrap; }
    .row { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    input[type=file] { background:#111; border:1px solid rgba(255,255,255,.12); border-radius:10px; padding:8px; color:#fff; }
  </style>
</head>
<body>
  <h1>Firebase Storage Sanity Test (Resumable)</h1>
  <div class="card">
    <p>Rechtstreekse upload naar je bucket met <b>uploadBytesResumable</b> + harde timeout + uitgebreide logs.</p>
    <p><b>Bucket:</b> <span id="bucket">(loading)</span></p>

    <div class="row" style="margin:12px 0">
      <button id="tiny" class="ok">Upload 1KB test</button>
      <input id="pick" type="file" accept="image/*" />
      <button id="filebtn" class="ok">Upload gekozen bestand</button>
    </div>

    <pre id="log"></pre>
  </div>

  <script>
    // Laat runtime errors altijd zien
    window.addEventListener("error", (e) => {
      const log = document.getElementById("log");
      log.textContent += "RUNTIME ERROR: " + (e.message || String(e)) + "\n";
    });
  </script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import {
      getStorage, ref, uploadBytesResumable, getDownloadURL
    } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-storage.js";

    // Prod-config (alleen voor deze testpagina)
    const firebaseConfig = {
      apiKey: "AIzaSyAMZCaCpBhMY482-BeSRJhXLe0xC0BkHw8",
      authDomain: "velvetframedb.firebaseapp.com",
      projectId: "velvetframedb",
      storageBucket: "velvetframedb.appspot.com",
      messagingSenderId: "1038595537948",
      appId: "1:1038595537948:web:4e445227d6233bc019f3d9",
    };

    const app = initializeApp(firebaseConfig);
    const storage = getStorage(app);

    const el = (id) => document.getElementById(id);
    const log = (...a) => { el("log").textContent += a.join(" ") + "\n"; };

    el("bucket").textContent = storage.app.options.storageBucket || "(unknown)";
    log("Ready. Click a button to upload.");

    function startResumable(path, blob) {
      const r = ref(storage, path);
      log("Start upload →", path, "| size:", blob.size);
      const task = uploadBytesResumable(r, blob, { cacheControl: "public,max-age=31536000,immutable" });

      // 20s timeout zodat 'stil hangen' zichtbaar wordt
      const kill = setTimeout(() => {
        log("TIMEOUT: canceling upload after 20s without completion.");
        try { task.cancel(); } catch {}
      }, 20000);

      task.on(
        "state_changed",
        (snap) => {
          const pct = Math.round((snap.bytesTransferred / snap.totalBytes) * 100);
          log(
            "STATE:", snap.state,
            "|", snap.bytesTransferred, "/", snap.totalBytes,
            `(${pct}%)`
          );
        },
        (err) => {
          clearTimeout(kill);
          log("ERROR:", err && (err.message || String(err)));
          console.error(err);
        },
        async () => {
          clearTimeout(kill);
          try {
            const url = await getDownloadURL(r);
            log("DONE →", url);
          } catch (e) {
            log("getDownloadURL ERROR:", e && (e.message || String(e)));
            console.error(e);
          }
        }
      );
    }

    el("tiny").addEventListener("click", () => {
      const blob = new Blob([new Uint8Array(1024)], { type: "application/octet-stream" });
      const path = `debug/${Date.now()}_tiny.bin`;
      startResumable(path, blob);
    });

    el("filebtn").addEventListener("click", () => {
      const f = el("pick").files?.[0];
      if (!f) return log("ERROR: No file selected.");
      const path = `debug/${Date.now()}_${f.name.replace(/\s+/g, "_")}`;
      startResumable(path, f);
    });
  </script>
</body>
</html>
